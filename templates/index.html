<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/static/index.css?v=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <title>Check Yourself</title>
</head>
<style>
    .AddComparison:hover{
        background-color: #3b88d5;
    }

    
</style>
<body>
    <h1>Check Yourself</h1>
    <p>Compare</p>
    <div class="slideshowComponent">
        <div class="slide">
            <h2>Salaries</h2>
        </div>
    </div>
    <div class="slideshowComponent">
        <div class="slide">
            <h2>Height</h2>
        </div>
    </div>
    <div class="slideshowComponent">
        <div class="slide">
            <h2>Grades</h2>
        </div>
    </div>
    <div class="slideshowComponent">
        <div class="slide">
            <h2>Weight</h2>
        </div>
    </div>
    <div class="slideshowComponent">
        <div class="slide">
            <h2>Skills</h2>
        </div>
    </div>
    <div class="slideshowComponent">
        <div class="slide">
            <h2>Everything</h2>
        </div>
    </div>

    <div class="form-container" id="form-container">
        <div id="individualForm">
            <form method="POST" action="/submit" id="theForm">
                <label for="subject">Subject:</label>
                <input type="text" id="subject" name="subject">
                <label for="grade">Grade:</label>
                <input type="text" id="grade" name="grade">
                <button type="submit">Submit</button>
            </form>
        </div>
        <div class="result" id="details">
            {{if .Show}}
                <p>Your Grade Puts you into the top: {{.Percent}}% in {{.Subject}}</p>
            {{end}}
        </div>
    </div>

    <div id = "avgElement" class = "avgElement" style="display: block;">
        <p></p>
    </div>

    <div class="canvas-container">
        <canvas id="rateSelf" width="30vh" height="40vh"></canvas>
    </div>

    <div class="AddComparison" id = "addComparison">
        <button type="submit" style="margin-bottom: 10vh;"> Add New Thing to compare against  </button>
    </div>

</body>
<script>
    document.getElementById('addComparison').addEventListener('click', addComponents);

    let slideIndex = 0;
    document.getElementById('theForm').addEventListener('submit', function(event){
    event.preventDefault();

    let formData = new FormData(this);
    fetch('/submit', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('details').innerText = data.message;
    })
    .catch(error => {
        document.getElementById('details').innerText = 'Error: ' + error;
    });
});

let formCount = 0; // Global counter for unique form IDs

function addComponents() {
    formCount++;
    let formId = 'theForm' + formCount;
    let resultId = 'details' + formCount;

    let form = document.createElement('form');
    form.setAttribute('method', 'post');
    form.setAttribute('action', '/submit');
    form.setAttribute('id', formId);
    form.classList.add('form');

    let subjectLabel = document.createElement('label');
    subjectLabel.textContent = 'Subject: ';
    subjectLabel.setAttribute('for', 'subject');

    let subjectInput = document.createElement('input');
    subjectInput.setAttribute('type', 'text');
    subjectInput.setAttribute('id', 'subject');
    subjectInput.setAttribute('name', 'subject');

    form.appendChild(subjectLabel);
    form.appendChild(subjectInput);

    let gradeLabel = document.createElement('label');
    gradeLabel.textContent = 'Grade: ';
    gradeLabel.setAttribute('for', 'grade');

    let gradeInput = document.createElement('input');
    gradeInput.setAttribute('type', 'text');
    gradeInput.setAttribute('id', 'grade');
    gradeInput.setAttribute('name', 'grade');

    form.appendChild(gradeLabel);
    form.appendChild(gradeInput);

    let break1 = document.createElement('br');

    const submitButton = document.createElement('button');
    submitButton.setAttribute('type', 'submit');
    submitButton.textContent = 'Submit';

    form.appendChild(submitButton);
    document.getElementById('form-container').appendChild(form);

    document.getElementById('form-container').appendChild(break1);
    document.getElementById('form-container').appendChild(break1);
    document.getElementById('form-container').appendChild(break1);

    // Add result div
    let resultDiv = document.createElement('div');
    resultDiv.setAttribute('class', 'result');
    resultDiv.setAttribute('id', resultId);

    let resultParagraph = document.createElement('p');
    resultParagraph.setAttribute('id', 'result-text');
    resultParagraph.style.display = 'none';

    resultDiv.appendChild(resultParagraph);
    document.getElementById('form-container').appendChild(resultDiv);

    // Add event listener to the new form
    form.addEventListener('submit', function(event) {
        event.preventDefault();

        let formData = new FormData(this);
        fetch('/submit', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById(resultId).innerText = data.message;
            getAverage()
        })
        .catch(error => {
            document.getElementById(resultId).innerText = 'Error: ' + error;
        });
    });

    console.log("Button Clicked");
}

function showSlides() {
    let i;
    let slides = document.getElementsByClassName("slideshowComponent");
    for (i = 0; i < slides.length; i++) {
        slides[i].style.display = "none";
    }

    slides[slideIndex].style.display = 'block';
    slideIndex++;
    if (slideIndex >= slides.length - 1) {
        setTimeout(showSlides, 350);
        slideIndex = slides.length - 1; // Keep "Everything" as the final slide
    } else {
        setTimeout(showSlides, 2000 / slideIndex);
    }
}

function getAverage(){
    let elements = document.getElementsByClassName('result');
    const regex = /-?\d+(\.\d+)?/g;
    let total = 0.0;
    let count = 0;

    for (let element of elements) {
        console.log(element.textContent);
        let match = element.textContent.match(regex);
        if (match) {
            let value = parseFloat(match[0]);
            if (!isNaN(value)) {
                total += value;
                count++;
            }
            console.log(value);
        }
    }

    if (count > 0){
        let avgElementNum = total / count;
        console.log("New Average", avgElementNum)
        
        avgElement = document.getElementById("avgElement");

        avgElement.textContent = "Your Avg across all is " + avgElementNum;


    }
}


document.addEventListener('DOMContentLoaded', (event) => {
    showSlides();
});
</script>
</html>
